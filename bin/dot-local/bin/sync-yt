#!/usr/bin/env bash
# Sincroniza una playlist de YouTube con una carpeta local (la del archivo .yt-config.yaml)
# Descarga los audios en formato MP3
# Requiere: yt-dlp y yq instalados

CONFIG_FILE=".yt-config.yaml"

# Verificar dependencias
for cmd in yt-dlp yq; do
  if ! command -v $cmd &>/dev/null; then
    echo "‚ùå Error: $cmd no est√° instalado. Inst√°lalo antes de continuar."
    exit 1
  fi
done

# Verificar archivo de configuraci√≥n
if [[ ! -f "$CONFIG_FILE" ]]; then
  echo "‚ùå No se encontr√≥ el archivo de configuraci√≥n $CONFIG_FILE"
  exit 1
fi

# Leer el ID de la playlist
PLAYLIST_ID=$(yq -r '.playlist_id' "$CONFIG_FILE")

if [[ -z "$PLAYLIST_ID" || "$PLAYLIST_ID" == "null" ]]; then
  echo "‚ùå Faltan datos en el archivo de configuraci√≥n (playlist_id)."
  exit 1
fi

# Carpeta donde est√° el archivo de configuraci√≥n
CONFIG_DIR=$(dirname "$(realpath "$CONFIG_FILE")")

# Construir URL de la playlist
PLAYLIST_URL="https://www.youtube.com/playlist?list=$PLAYLIST_ID"

echo "üéµ Sincronizando playlist: $PLAYLIST_URL"
echo "üìÅ Carpeta destino: $CONFIG_DIR"
echo "üéß Formato de salida: MP3"

# Ejecutar yt-dlp para sincronizar y extraer audio en MP3
yt-dlp \
  --yes-playlist \
  --ignore-errors \
  --no-overwrites \
  -t sleep \
  --continue \
  --download-archive "$CONFIG_DIR/.downloaded.txt" \
  -o "$CONFIG_DIR/%(n_entries+1-playlist_index)03d - %(upload_date)s - %(title)s.%(ext)s" \
  -f "bestaudio/best" \
  --extractor-args "youtube:player_js_version=actual" \
  --extract-audio \
  --audio-format mp3 \
  --audio-quality 0 \
  "$PLAYLIST_URL"

echo "‚úÖ Sincronizaci√≥n completada en $CONFIG_DIR"
